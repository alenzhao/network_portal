{% extends "base2.html" %}
{% block title %}Network Portal - Search{% endblock %}
{% block cssspecial %}<link rel="stylesheet" href="{{ STATIC_PREFIX }}stylesheets/redmond/jquery-ui-1.8.16.custom.css">{% endblock %}
{% block content %}
{% load static %}
{% get_static_prefix as STATIC_PREFIX %}
<script type="text/javascript">
$(document).ready(function() {
    $("#query").autocomplete({
      source: function(request, response) {
        $.ajax({
          url:      "http://networks.systemsbiology.net:8983/solr/suggest/?wt=json&json.wrf=?",
          crossDomain: true,
          dataType: "jsonp",
          async: false,
          data: { q: request.term },
          success: function(data) {
              response(data.spellcheck.suggestions[1].suggestion);
          }
        });
      },
      minLength: 1,
      select: function (event, ui) { }
    });

    $(".example-search").click(function(event) {
        $("#query").val($(event.target).text());
    });
    // Selections in result table
    var geneMap = {};
    {% for result in genes %}
    geneMap[{{result.id}}] = {species: '{{result.species_name}}',
                              biclusters: [{% if biclusters %}{% for bi_result in biclusters %}{% for k in bi_result.bi_gene_name %}{% if result.gene_name == k %}{{bi_result.bicluster_id}}, {% endif %}{% endfor %}{% endfor %}]{% endif %}
                             };{% endfor %}

    function check_selection(geneMap) {
        var selectBoxes = $('[id^=sel_gene]');
        var selectedGenes = [];
        for (i = 0; i < selectBoxes.length; i++) {
            if (selectBoxes[i].checked) {
                var comps = selectBoxes[i].id.split('_');
                var id = comps[comps.length - 1];
                selectedGenes[selectedGenes.length] = geneMap[id];
            }
        }
        if (selectedGenes.length === 0) {
            $('<div id="display-network"></div>').replaceAll('#display-network');
            return;
        }
        var species = selectedGenes[0].species;
        var biclusters = [];
        for (i = 0; i < selectedGenes.length; i++) {
            if (species !== selectedGenes[i].species) {
                biclusters = [];
                break;
            }
            for (j = 0; j < selectedGenes[i].biclusters.length; j++) {
                if (biclusters.indexOf(selectedGenes[i].biclusters[j]) === -1) {
                    biclusters[biclusters.length] = selectedGenes[i].biclusters[j];
                }
            }
        }
        if (biclusters.length > 0) {
            var ids = biclusters.join(',');
            $('<div id="display-network"><a href="/network?biclusters=' + ids + '">view network for selected regulons (' + biclusters.length + ')</a></div>').replaceAll('#display-network');
        } else {
            $('<div id="display-network"></div>').replaceAll('#display-network');
        }
    }

    $("#sel_all_genes").click(function(event) {
        $('[id^=sel_gene]').prop('checked', $('#sel_all_genes').prop('checked'));
        check_selection(geneMap);
    });
    $('[id^=sel_gene]').click(function(event) {
        check_selection(geneMap);
    });
});
</script>

<div id="main" class="sub-page">
  <h5>Search</h5>
  <span id="search_help">(Start typing keywords, press ESC to close suggestions)</span>
  <form action="/search/" method="get">
    <ul id="search">
      <input type="text" id="query" name="q" value="{{ q }}"></input>
      <input type="submit" value="Search"></input>
    </ul>
  </form>
  <p><b>Example 1: </b><span class="example-search">DVU0848 DVU0694 DVU0693 DVU0778 DVU0846</span>
  <span id="search_help">(Click to add)</span></p>
  <p><b>Example 2: </b><span class="example-search">thioredoxin, oxidative</span>
  <span id="search_help">(Click to add)</span></p>
  {% if error_message %}
  <div id="error_message">
    <h4>Search Error</h4>
    <p>{{ error_message }}</p>
  </div>
  {% endif %}
  {% if q %}
  {% if results %}
  {% if count == 1 %}
  <p> testing {{ results|length }}</p>
  {% else %}
  <p><font color=#FF4040>Found {{ gene_count }} gene results for "{{ q }}".</font></p>
  {% endif %}
  <!-- The following displays a unique list of functions found among
       the queried set of Genes
  -->
  <!-- Uncomment if user wants to see Genes/Functions/Regulons separated into respective chunks
       <ul>
       {% for term in unique %}
       <li id="gene-function">{{ term }} </li>
       {% endfor %}
       </ul>
  -->
  <!--    Uncomment if user wants to see Gene: Functions -->
  <table id="gene-results">
    <caption> Search results</caption>
    <tbody>
      <tr>
        <th><input type="checkbox" id="sel_all_genes"></input></th>
	<th>Genes</th>
	<th>Description</th>
	<th>Regulated by</th>
	<th>Regulates</th>
	<th>In Regulons</th>
	<!--<th>GO</th>
	<th>KEGG</th>
	<th>COG</th>
	<th>Regulons</th>-->
      </tr>
      {% for result in genes %}
      <tr>
        <td><input type="checkbox" id="sel_gene_{{result.id}}"></input></td>
        <td><a href="/gene/{{ result.gene_name }}">{{ result.gene_name }}</a></td>
        <td>{{ result.gene_description }}</td>
	{% if ret %}
	{% for gname, func in ret %}
	{% if gname == result.gene_name %}
	<td>Regulated by</td>
	<td>Regulates</td>
	
<!--	<td>
	  {% for type, name, term_id in func %}
	  {% if type == 'go' %}
	  <li id="gene-function">{{ name }} <br />(<a href="http://amigo.geneontology.org/cgi-bin/amigo/term_details?term={{term_id}}">{{ term_id }}</a>),</li>
	  {% endif %}
	  {% endfor %}
	</td>
	<td>
	  {% for type, name, term_id in func %}
	  {% if type == 'kegg' %}
	  <li id="gene-function">{{ name }} <br />(<a href="http://www.genome.jp/kegg-bin/show_pathway?map{{ term_id }}">path:{{ term_id }}</a>),</li>
	  {% endif %}
	  {% endfor %}
	</td>
	<td>
	  {% for type, name, term_id in func %}
	  {% if type == 'cog' %}
	  <li id="gene-function">{{ name }} <br />(<a href="http://www.ncbi.nlm.nih.gov/COG/grace/wiew.cgi?{{ term_id }}">{{ term_id }}</a>),</li>
	  {% endif %}
	  {% endfor %}
	</td>
	{% endif %} <!--if gname -->
	{% endfor %} <!-- for gname -->
	{% else %}
	<td>
	  <li id="gene-function">Unknown</li>
	</td>
	<td>
	  <li id="gene-function">Unknown</li>
	</td>
	<td>
	  <li id="gene-function">Unknown</li>
	</td>
	{% endif %} <!-- if ret -->
	<td>

	{% if biclusters %}
	  {% for bi_result in biclusters %}
	    {% for k in bi_result.bi_gene_name %}
	      {% if result.gene_name == k %}
	        <li id="gene-regulon"><a href="/bicluster/{{ bi_result.bicluster_id }}">regulon {{ bi_result.bicluster_id }}</a>,</li>
	      {% endif %}
	    {% endfor %}
	  {% endfor %}
	{% endif %} <!-- if biclusters -->
	</td>
      </tr>
      {% endfor %} <!-- for result in genes -->
      </tbody>
    </table>
    <p><div id="display-network"></div></p>
    {% else %}
    <p><b>No results found!</b></p>
    {% endif %} <!-- for results -->
    {% endif %} <!-- if q -->
</div><!-- End #main -->
{% endblock %}
